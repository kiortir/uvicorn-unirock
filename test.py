import requests
from requests.structures import CaseInsensitiveDict
from sql_app import amo_query_schema, amo_webhook_schema
from sql_app import crud
import ast
from typing import List
import json
from pydantic import parse_obj_as


def get_leads(a_token="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjhkMzNmYzM4ZGI3ZDUwYzY0NzM5MTRkMTQ0NzYyMzM1NTkzZWEwMTNlYmRkNTJlOTk4NzE0YjJlMzg2MjdmOGQxMDg2NWMxNDM0ZTNiYzlmIn0.eyJhdWQiOiIwNGJmZDllZC0zZmMyLTRlZWMtOGY2OC00OGFkY2IyNDk2MGUiLCJqdGkiOiI4ZDMzZmMzOGRiN2Q1MGM2NDczOTE0ZDE0NDc2MjMzNTU5M2VhMDEzZWJkZDUyZTk5ODcxNGIyZTM4NjI3ZjhkMTA4NjVjMTQzNGUzYmM5ZiIsImlhdCI6MTYyNzQ3NDYwMiwibmJmIjoxNjI3NDc0NjAyLCJleHAiOjE2Mjc1NjEwMDIsInN1YiI6IjY2Mzc2NzgiLCJhY2NvdW50X2lkIjoxNjcwMDY4MCwic2NvcGVzIjpbInB1c2hfbm90aWZpY2F0aW9ucyIsImNybSIsIm5vdGlmaWNhdGlvbnMiXX0.ppkmba3kOgqjOD9-JQk5NggdxjmkA5Ux3Q4xqWIvNUsAvXFChQ-jApK0tZtO3PqpoPzRZ-xZkJ8JjoUdAn1QMwSul5BvxSjhXi8Y24jWWS30dzPEVOIpFGSVTm_R4JDAIZhAcnBd-bPhcx63sj2exI_KFI6CttTFjxaBKYyEjZmOOdv4ZGJ4c9VjHFoOiCBFLZlrwRnFDDjSQLbCUwT3qGKl3LLuNxxO54uLJLCV27x7Muf3SPqcxJzh3FXOyUxzXyS9vFTts6YGkVc-SbSrl5oqXigKT3iKNN5XG1WldPp1d0yp3dPL1l-7XADq4fp7Z7HKIT_1AIwF7IXK4Dd44w",
              url="https://unirock.amocrm.ru/api/v4/leads?limit=250",
              filter_query='%3Ffilter%5Btags_logic%5D=or&filter%3Ffilter%5Btags_logic%5D=or&filter%5Bpipe%5D%5B946942%5D%5B0%5D=18032857&filter%5Bpipe%5D%5B946942%5D%5B1%5D=18032860&filter%5Bpipe%5D%5B946942%5D%5B2%5D=18032863&filter%5Bpipe%5D%5B946942%5D%5B3%5D=18033010&filter%5Bpipe%5D%5B946942%5D%5B4%5D=18062053&filter%5Bpipe%5D%5B946942%5D%5B5%5D=39719170',
              page=1):
    url = f"{url}&{filter_query}&page={page}"
    headers = CaseInsensitiveDict()
    headers["Authorization"] = f"Bearer {a_token}"
    response = requests.get(url, headers=headers, timeout=5)
    if response.status_code != 200 and response.status_code != 204:
        raise Exception(f"Status code: {response.status_code}; response: {response.content}")
    if response.status_code == 204:  # выход из рекурсии
        return None
    leads = response.json()['_embedded']['leads']
    next_page = get_leads(page=page + 1)
    if next_page is None:
        return leads
    else:
        return leads + next_page


if __name__ == '__main__':
    # z = requests.post('http://127.0.0.1:8000/webhook/',
    #                   data='leads%5Bupdate%5D%5B0%5D%5Bid%5D=23650479&leads%5Bupdate%5D%5B0%5D%5Bname%5D=%D0%90%D0%B2%D1%82%D0%BE%D1%81%D0%B4%D0%B5%D0%BB%D0%BA%D0%B0%3A+%D0%9F%D0%9E%D0%A1%D0%A0%D0%95%D0%94%D0%9D%D0%98%D0%9A&leads%5Bupdate%5D%5B0%5D%5Bstatus_id%5D=18032863&leads%5Bupdate%5D%5B0%5D%5Bold_status_id%5D=18032860&leads%5Bupdate%5D%5B0%5D%5Bprice%5D=119516&leads%5Bupdate%5D%5B0%5D%5Bresponsible_user_id%5D=7196971&leads%5Bupdate%5D%5B0%5D%5Blast_modified%5D=1627376500&leads%5Bupdate%5D%5B0%5D%5Bmodified_user_id%5D=3583384&leads%5Bupdate%5D%5B0%5D%5Bcreated_user_id%5D=0&leads%5Bupdate%5D%5B0%5D%5Bdate_create%5D=1625141673&leads%5Bupdate%5D%5B0%5D%5Bpipeline_id%5D=946942&leads%5Bupdate%5D%5B0%5D%5Btags%5D%5B0%5D%5Bid%5D=73801&leads%5Bupdate%5D%5B0%5D%5Btags%5D%5B0%5D%5Bname%5D=tilda&leads%5Bupdate%5D%5B0%5D%5Baccount_id%5D=16700680&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bid%5D=436799&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bname%5D=utm_medium&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bcode%5D=UTM_MEDIUM&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B1%5D%5Bid%5D=439295&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B1%5D%5Bname%5D=utm_campaign&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B1%5D%5Bcode%5D=UTM_CAMPAIGN&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B2%5D%5Bid%5D=467289&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B2%5D%5Bname%5D=%D0%9C%D0%B5%D0%BD%D0%B5%D0%B4%D0%B6%D0%B5%D1%80+%D0%BF%D0%BE+%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B6%D0%B0%D0%BC&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B2%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%92%D0%BB%D0%B0%D0%B4%D0%B0+%D0%A0%D1%8B%D1%82%D0%BE%D0%B2%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B2%5D%5Bvalues%5D%5B0%5D%5Benum%5D=960551&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B3%5D%5Bid%5D=445621&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B3%5D%5Bname%5D=%D0%A1%D1%82%D0%BE%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C+%D0%B7%D0%B0%D0%BC%D0%B5%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B3%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B4%5D%5Bid%5D=445613&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B4%5D%5Bname%5D=%D0%A0%D0%BE%D0%B7%D0%BD%D0%B8%D1%87%D0%BD%D0%B0%D1%8F+%D1%86%D0%B5%D0%BD%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B4%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=109716%2B9800&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B5%5D%5Bid%5D=19747&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B5%5D%5Bname%5D=%D0%A4%D0%BE%D1%80%D0%BC%D0%B0+%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D1%8B&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B5%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%9F%D0%BE+%D1%81%D1%87%D1%91%D1%82%D1%83&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B5%5D%5Bvalues%5D%5B0%5D%5Benum%5D=43233&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B6%5D%5Bid%5D=445615&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B6%5D%5Bname%5D=%D0%9D%D0%B0%D0%BA%D1%80%D1%83%D1%82%D0%BA%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B6%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B7%5D%5Bid%5D=445619&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B7%5D%5Bname%5D=%D0%9F%D1%80%D0%B5%D0%B4%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B7%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=109716%2B9800&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B8%5D%5Bid%5D=493839&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B8%5D%5Bname%5D=%D0%A1%D1%83%D0%BC%D0%BC%D0%B0+%D0%B4%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D1%8B&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B8%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B9%5D%5Bid%5D=445633&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B9%5D%5Bname%5D=%D0%92%D0%B8%D0%B4+%D0%BA%D0%B0%D0%BC%D0%BD%D1%8F&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B9%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=GRandex+M-711&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B10%5D%5Bid%5D=467291&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B10%5D%5Bname%5D=%D0%97%D0%B0%D0%BC%D0%B5%D1%80%D1%89%D0%B8%D0%BA&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B10%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%90%D0%BB%D0%B5%D0%BD%D0%B0+%D0%9D%D0%B5%D1%84%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B10%5D%5Bvalues%5D%5B0%5D%5Benum%5D=920759&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B11%5D%5Bid%5D=19743&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B11%5D%5Bname%5D=%D0%94%D0%B0%D1%82%D0%B0+%D0%B7%D0%B0%D0%BC%D0%B5%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B11%5D%5Bvalues%5D%5B0%5D=1625086800&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B12%5D%5Bid%5D=444919&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B12%5D%5Bname%5D=%D0%92%D1%80%D0%B5%D0%BC%D1%8F+%D0%B7%D0%B0%D0%BC%D0%B5%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B12%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=08+%E2%80%93+10&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B12%5D%5Bvalues%5D%5B0%5D%5Benum%5D=884085&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B13%5D%5Bid%5D=444923&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B13%5D%5Bname%5D=%D0%9E%D0%B1%D0%B5%D1%89%D0%B0%D0%BD%D0%BD%D0%B0%D1%8F+%D0%B4%D0%B0%D1%82%D0%B0+%D0%BC%D0%BE%D0%BD%D1%82%D0%B0%D0%B6%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B13%5D%5Bvalues%5D%5B0%5D=1626901200&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B14%5D%5Bid%5D=479169&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B14%5D%5Bname%5D=%D0%A2%D1%80%D0%B5%D0%B1%D1%83%D0%B5%D1%82%D1%81%D1%8F+%D0%BF%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BC%D0%B5%D1%80&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B14%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=1&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B15%5D%5Bid%5D=466941&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B15%5D%5Bname%5D=%D0%9F%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D1%89%D0%B8%D0%BA&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B15%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=Grandex&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B16%5D%5Bid%5D=466943&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B16%5D%5Bname%5D=%D0%9D%D0%BE%D0%BC%D0%B5%D0%BD%D0%BA%D0%BB%D0%B0%D1%82%D1%83%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B16%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=M-711&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B17%5D%5Bid%5D=466945&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B17%5D%5Bname%5D=%D0%9B%D0%B8%D1%81%D1%82%D1%8B&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B17%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=1.25&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B18%5D%5Bid%5D=466947&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B18%5D%5Bname%5D=%D0%9A%D0%BB%D0%B5%D0%B9&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B18%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=3&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B19%5D%5Bid%5D=466953&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B19%5D%5Bname%5D=%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%87%D0%B0%D0%BD%D0%B8%D0%B5+%D0%BA+%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D1%83&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B19%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8%D0%B0%D0%BB+%D0%B2+%D1%86%D0%B5%D1%85%D1%83&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B20%5D%5Bid%5D=466955&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B20%5D%5Bname%5D=%D0%9C%D0%BE%D0%B9%D0%BA%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B20%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=classic400R&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B21%5D%5Bid%5D=467043&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B21%5D%5Bname%5D=%D0%A1%D1%82%D0%B0%D1%82%D1%83%D1%81&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B21%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%9F%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B8%D0%BB%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B21%5D%5Bvalues%5D%5B0%5D%5Benum%5D=917297&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B22%5D%5Bid%5D=466963&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B22%5D%5Bname%5D=%D0%9C%D0%B0%D1%81%D1%82%D0%B5%D1%80&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B22%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%9A%D0%BE%D1%81%D1%8B%D0%B3%D0%B8%D0%BD&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B22%5D%5Bvalues%5D%5B0%5D%5Benum%5D=963341&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B23%5D%5Bid%5D=942875&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B23%5D%5Bname%5D=%D0%94%D0%B0%D1%82%D0%B0+%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8+%D0%B2+%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B23%5D%5Bvalues%5D%5B0%5D=1627333200&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B24%5D%5Bid%5D=934909&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B24%5D%5Bname%5D=%D0%A1%D1%80%D0%BE%D0%BA+%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B24%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=6&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B25%5D%5Bid%5D=437987&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B25%5D%5Bname%5D=%D0%9D%D0%BE%D0%BC%D0%B5%D1%80+%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B25%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=9522&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B26%5D%5Bid%5D=942785&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B26%5D%5Bname%5D=%D0%94%D0%B0%D1%82%D0%B0+%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B26%5D%5Bvalues%5D%5B0%5D=1625518800&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B27%5D%5Bid%5D=475519&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B27%5D%5Bname%5D=%D0%94%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80+%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%B0%D0%BD+%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%BE%D0%BC&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B27%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=1&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B28%5D%5Bid%5D=942617&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B28%5D%5Bname%5D=%D0%94%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80+%D0%BE%D1%84%D0%BE%D1%80%D0%BC%D0%BB%D0%B5%D0%BD&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B28%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%9F%D0%BE%D1%81%D0%BB%D0%B5+%D0%B7%D0%B0%D0%BC%D0%B5%D1%80%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B28%5D%5Bvalues%5D%5B0%5D%5Benum%5D=965341&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B29%5D%5Bid%5D=491089&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B29%5D%5Bname%5D=%D0%A1%D1%80%D0%BE%D0%BA+%D0%BF%D0%BE+%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D1%83&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B29%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=12&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B30%5D%5Bid%5D=19749&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B30%5D%5Bname%5D=%D0%98%D0%B7%D0%B4%D0%B5%D0%BB%D0%B8%D0%B5&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B30%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%A1%D1%82%D0%BE%D0%BB%D0%B5%D1%88%D0%BD%D0%B8%D1%86%D0%B0-%D1%81%D0%B0%D0%BD%D1%83%D0%B7%D0%B5%D0%BB&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B30%5D%5Bvalues%5D%5B0%5D%5Benum%5D=43237&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B31%5D%5Bid%5D=19713&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B31%5D%5Bname%5D=%D0%9C%D0%B0%D1%82%D0%B5%D1%80%D0%B8%D0%B0%D0%BB&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B31%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D0%90%D0%BA%D1%80%D0%B8%D0%BB&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B31%5D%5Bvalues%5D%5B0%5D%5Benum%5D=43147&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B32%5D%5Bid%5D=435829&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B32%5D%5Bname%5D=r7k12id&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B32%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=280913911&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B33%5D%5Bid%5D=475185&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B33%5D%5Bname%5D=%D0%98%D1%81%D1%82%D0%BE%D1%87%D0%BD%D0%B8%D0%BA+%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B33%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=yandex&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B34%5D%5Bid%5D=436839&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B34%5D%5Bname%5D=%D0%9A%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D0%BE%D0%B5+%D1%81%D0%BB%D0%BE%D0%B2%D0%BE&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B34%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=%D1%81%D1%82%D0%BE%D0%BB%D0%B5%D1%88%D0%BD%D0%B8%D1%86%D0%B0+%D0%B4%D0%BB%D1%8F+%D0%BA%D1%83%D1%85%D0%BD%D0%B8+%D0%BA%D0%B2%D0%B0%D1%80%D1%86%D0%B5%D0%B2%D1%8B%D0%B9+%D0%BA%D0%B0%D0%BC%D0%B5%D0%BD%D1%8C&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B35%5D%5Bid%5D=482151&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B35%5D%5Bname%5D=%D0%A2%D0%B8%D0%BF+%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0&leads%5Bupdate%5D%5B0%5D%5Bcustom_fields%5D%5B35%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=desktop&leads%5Bupdate%5D%5B0%5D%5Bcreated_at%5D=1625141673&leads%5Bupdate%5D%5B0%5D%5Bupdated_at%5D=1627376500&account%5Bsubdomain%5D=unirock&account%5Bid%5D=16700680&account%5B_links%5D%5Bself%5D=https%3A%2F%2Funirock.amocrm.ru')
    # print(z.text)

    # leads = get_leads()
    # with open('test.txt', 'w', encoding='utf-8') as f:
    #     f.write(str(leads))
    from amo_handlers import webhook_handler

    with open('test.txt', 'r', encoding='utf-8') as f:
        z = f.read()

    leads = json.loads(z)
    z = ast.literal_eval(z)
    def to_schema(data: dict) -> amo_query_schema.Model:
        return amo_query_schema.Model.parse_obj(data)

    def to_schema_many(data: List[dict]) -> List[amo_query_schema.Model]:
        return parse_obj_as(List[amo_query_schema.Model], data)

    u = webhook_handler.handle_hook(z)
    print(u)
